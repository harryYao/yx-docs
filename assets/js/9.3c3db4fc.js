(window.webpackJsonp=window.webpackJsonp||[]).push([[9],{276:function(t,s,n){"use strict";n.r(s);var a=n(16),e=Object(a.a)({},(function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[n("h1",{attrs:{id:"process-nexttick"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#process-nexttick"}},[t._v("#")]),t._v(" process.nextTick()")]),t._v(" "),n("p",[t._v("宏任务和微任务（一个宏任务配多个微任务）：每次执行微任务队列会全部执行完并清空")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[t._v("console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'main'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nprocess"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("nextTick")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'process.nextTick1'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("setTimeout")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'setTimeout'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  process"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("nextTick")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'process.nextTick2'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Promise")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("resolve"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" reject")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'promise'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("resolve")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'promise then'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\nconsole"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'main2'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),n("p",[t._v("执行结果")]),t._v(" "),n("p",[t._v("main   // 宏任务\npromise  // 宏任务\nmain2  // 宏任务\nprocess.nextTick1  // 微任务\npromise then  // 微任务\nsetTimeout  // 宏任务2\nprocess.nextTick2 // 宏任务2下的微任务")]),t._v(" "),n("p",[n("strong",[t._v("rocess.nextTick()知识点")])]),t._v(" "),n("ul",[n("li",[t._v("process.nextTick()会将callback添加到”next tick queue“")]),t._v(" "),n("li",[t._v("”next tick queue“会在当前JavaScript stack执行完成后，下一次event loop开始执行前按照FIFO出队")]),t._v(" "),n("li",[t._v("如果递归调用process.nextTick()可能会导致一个无限循环，需要去适时终止递归。")]),t._v(" "),n("li",[t._v("process.nextTick()可用于控制代码执行顺序。保证方法在对象完成constructor后但是在I/O发生前调用。")]),t._v(" "),n("li",[t._v("process.nextTick()可完全异步化API。API要么100%同步要么100%异步是很重要的，可以通过process.nextTick()去达到这种保证")])]),t._v(" "),n("hr"),t._v(" "),n("p",[t._v("理解 process.nextTick() 参考文档：")]),t._v(" "),n("p",[t._v("强大的异步专家process.nextTick()\nhttps://www.jianshu.com/p/5328c72279ff")]),t._v(" "),n("p",[t._v("https://nodejs.org/zh-cn/docs/guides/event-loop-timers-and-nexttick/\nhttps://www.oschina.net/translate/understanding-process-next-tick?print")]),t._v(" "),n("h2",{attrs:{id:"process-nexttick-和-setimmediate-的区别"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#process-nexttick-和-setimmediate-的区别"}},[t._v("#")]),t._v(" Process.nextTick 和 setImmediate 的区别？")]),t._v(" "),n("p",[t._v("https://www.zhihu.com/question/23028843")]),t._v(" "),n("p",[t._v("https://segmentfault.com/a/1190000013102056?utm_source=tag-newest")]),t._v(" "),n("h2",{attrs:{id:"node中事件循环阶段解析"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#node中事件循环阶段解析"}},[t._v("#")]),t._v(" Node中事件循环阶段解析")]),t._v(" "),n("p",[t._v("下面是事件循环不同阶段的示意图：")]),t._v(" "),n("img",{attrs:{src:t.$withBase("/imgs/node_event_loop.png"),alt:"foo"}}),t._v("\n每个阶段都有一个先进先出的回调队列要执行。而每个阶段都有自己的特殊之处。简单来说，就是当事件循环进入某个阶段后，会执行该阶段特定的任意操作，然后才会执行这个阶段里的回调。当队列被执行完，或者执行的回调数量达到上限后，事件循环才会进入下一个阶段。\n"),n("ol",[n("li",[t._v("timers\n一个timer指定一个下限时间而不是准确时间，在达到这个下限时间后执行回调。在指定的时间过后，timers会尽早的执行回调，但是系统调度或者其他回调的执行可能会延迟它们。")])]),t._v(" "),n("blockquote",[n("p",[t._v("从技术上来说，poll阶段控制timers什么时候执行，而执行的具体位置在timers。\n下限的时间有一个范围：[1, 2147483647]，如果设定的时间不在这个范围，将被设置为1。")])]),t._v(" "),n("ol",{attrs:{start:"2"}},[n("li",[n("p",[t._v("I/O callbacks\n这个阶段执行一些系统操作的回调，比如说TCP连接发生错误。")])]),t._v(" "),n("li",[n("p",[t._v("idle, prepare\n系统内部的一些调用。")])]),t._v(" "),n("li",[n("p",[t._v("poll\n这是最复杂的一个阶段。")])])]),t._v(" "),n("p",[t._v("poll阶段有两个主要的功能："),n("strong",[t._v("一是执行下限时间已经达到的timers的回调，一是处理poll队列里的事件。")])]),t._v(" "),n("p",[t._v("当事件循环进入poll阶段：")]),t._v(" "),n("ul",[n("li",[n("p",[t._v("poll队列不为空的时候，事件循环肯定是先遍历队列并同步执行回调，直到队列清空或执行回调数达到系统上限。")])]),t._v(" "),n("li",[n("p",[t._v("poll队列为空的时候，这里有两种情况。")]),t._v(" "),n("ul",[n("li",[n("p",[t._v("如果代码已经被setImmediate()设定了回调，那么事件循环直接结束poll阶段进入check阶段来执行check队列里的回调。")])]),t._v(" "),n("li",[n("p",[t._v("如果代码没有被设定setImmediate()设定回调：")]),t._v(" "),n("ul",[n("li",[t._v("如果有被设定的timers，那么此时事件循环会检查timers，如果有一个或多个timers下限时间已经到达，那么事件循环将绕回timers阶段，并执行timers的有效回调队列。")]),t._v(" "),n("li",[t._v("如果没有被设定timers，这个时候事件循环是阻塞在poll阶段等待回调被加入poll队列。")])])])])])]),t._v(" "),n("ol",{attrs:{start:"5"}},[n("li",[t._v("check\n这个阶段允许在poll阶段结束后立即执行回调。如果poll阶段空闲，并且有被setImmediate()设定的回调，那么事件循环直接跳到check执行而不是阻塞在poll阶段等待回调被加入。")])]),t._v(" "),n("p",[t._v("setImmediate()实际上是一个特殊的timer，跑在事件循环中的一个独立的阶段。它使用libuv的API来设定在poll阶段结束后立即执行回调。")]),t._v(" "),n("p",[n("strong",[t._v("注：setImmediate()具有最高优先级，只要poll队列为空，代码被setImmediate()，无论是否有timers达到下限时间，setImmediate()的代码都先执行。")])]),t._v(" "),n("ol",{attrs:{start:"6"}},[n("li",[t._v("close callbacks\n如果一个socket或handle被突然关掉（比如socket.destroy()），close事件将在这个阶段被触发，否则将通过process.nextTick()触发。")])])])}),[],!1,null,null,null);s.default=e.exports}}]);