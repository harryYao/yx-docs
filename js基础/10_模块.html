<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>js模块化编程之彻底弄懂CommonJS和AMD/CMD！ | 前端小记</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="shortcut icon" type="image/x-icon" href="/yx-docs/favicon.ico">
    <meta name="description" content="yaoxin的笔记文档">
    
    <link rel="preload" href="/yx-docs/assets/css/0.styles.f26e5750.css" as="style"><link rel="preload" href="/yx-docs/assets/js/app.5a460998.js" as="script"><link rel="preload" href="/yx-docs/assets/js/2.beed6d36.js" as="script"><link rel="preload" href="/yx-docs/assets/js/29.c181a55e.js" as="script"><link rel="prefetch" href="/yx-docs/assets/js/10.ef9da421.js"><link rel="prefetch" href="/yx-docs/assets/js/11.9b5392f0.js"><link rel="prefetch" href="/yx-docs/assets/js/12.709b7d3b.js"><link rel="prefetch" href="/yx-docs/assets/js/13.21ee67c2.js"><link rel="prefetch" href="/yx-docs/assets/js/14.3e877896.js"><link rel="prefetch" href="/yx-docs/assets/js/15.38c2c5fd.js"><link rel="prefetch" href="/yx-docs/assets/js/16.fc417a38.js"><link rel="prefetch" href="/yx-docs/assets/js/17.399b3d5f.js"><link rel="prefetch" href="/yx-docs/assets/js/18.e8b9f64e.js"><link rel="prefetch" href="/yx-docs/assets/js/19.bcba6736.js"><link rel="prefetch" href="/yx-docs/assets/js/20.ad22a0aa.js"><link rel="prefetch" href="/yx-docs/assets/js/21.abf37f07.js"><link rel="prefetch" href="/yx-docs/assets/js/22.15816c2d.js"><link rel="prefetch" href="/yx-docs/assets/js/23.3118e001.js"><link rel="prefetch" href="/yx-docs/assets/js/24.262d541f.js"><link rel="prefetch" href="/yx-docs/assets/js/25.d5d5b31f.js"><link rel="prefetch" href="/yx-docs/assets/js/26.f8ad1c03.js"><link rel="prefetch" href="/yx-docs/assets/js/27.563d7bf1.js"><link rel="prefetch" href="/yx-docs/assets/js/28.0d36fbb9.js"><link rel="prefetch" href="/yx-docs/assets/js/3.3cc5e67c.js"><link rel="prefetch" href="/yx-docs/assets/js/30.b10c9ca6.js"><link rel="prefetch" href="/yx-docs/assets/js/31.88aeca61.js"><link rel="prefetch" href="/yx-docs/assets/js/32.eea9e6c5.js"><link rel="prefetch" href="/yx-docs/assets/js/33.2053affe.js"><link rel="prefetch" href="/yx-docs/assets/js/34.1c109941.js"><link rel="prefetch" href="/yx-docs/assets/js/35.b38f3547.js"><link rel="prefetch" href="/yx-docs/assets/js/36.b65774cc.js"><link rel="prefetch" href="/yx-docs/assets/js/37.f0220103.js"><link rel="prefetch" href="/yx-docs/assets/js/38.ba52d01e.js"><link rel="prefetch" href="/yx-docs/assets/js/39.4600b9a1.js"><link rel="prefetch" href="/yx-docs/assets/js/4.8fdb6c92.js"><link rel="prefetch" href="/yx-docs/assets/js/40.d5f9b7fe.js"><link rel="prefetch" href="/yx-docs/assets/js/41.654e2c88.js"><link rel="prefetch" href="/yx-docs/assets/js/42.3259130c.js"><link rel="prefetch" href="/yx-docs/assets/js/43.1015a155.js"><link rel="prefetch" href="/yx-docs/assets/js/44.461a5dfe.js"><link rel="prefetch" href="/yx-docs/assets/js/45.eb84978a.js"><link rel="prefetch" href="/yx-docs/assets/js/46.baa40100.js"><link rel="prefetch" href="/yx-docs/assets/js/47.488253f5.js"><link rel="prefetch" href="/yx-docs/assets/js/48.8acdad8d.js"><link rel="prefetch" href="/yx-docs/assets/js/49.aa4d5576.js"><link rel="prefetch" href="/yx-docs/assets/js/5.29239ed8.js"><link rel="prefetch" href="/yx-docs/assets/js/50.c1787f29.js"><link rel="prefetch" href="/yx-docs/assets/js/51.937bb7f3.js"><link rel="prefetch" href="/yx-docs/assets/js/52.dd17becb.js"><link rel="prefetch" href="/yx-docs/assets/js/6.52d05a44.js"><link rel="prefetch" href="/yx-docs/assets/js/7.e52f16a3.js"><link rel="prefetch" href="/yx-docs/assets/js/8.887870a8.js"><link rel="prefetch" href="/yx-docs/assets/js/9.3c3db4fc.js">
    <link rel="stylesheet" href="/yx-docs/assets/css/0.styles.f26e5750.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/yx-docs/" class="home-link router-link-active"><img src="/yx-docs/logo.png" alt="前端小记" class="logo"> <span class="site-name can-hide">前端小记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://github.com/harryYao" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GITHUB
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://github.com/harryYao" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GITHUB
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>JS笔记</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/yx-docs/js基础/01_js类型.html" class="sidebar-link">js基础类型</a></li><li><a href="/yx-docs/js基础/02_dom操作.html" class="sidebar-link">DOM操作</a></li><li><a href="/yx-docs/js基础/03_原型原型链.html" class="sidebar-link">原型 prototype</a></li><li><a href="/yx-docs/js基础/04_作用域作用域链.html" class="sidebar-link">作用域 &amp; 作用域链</a></li><li><a href="/yx-docs/js基础/05_闭包.html" class="sidebar-link">闭包 closure</a></li><li><a href="/yx-docs/js基础/06_继承.html" class="sidebar-link">继承</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>CSS笔记</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/yx-docs/css基础/01_选择器.html" class="sidebar-link">css选择器</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>博客文章</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/yx-docs/articles/window.name.html" class="sidebar-link">window.name</a></li><li><a href="/yx-docs/articles/图片盗链.html" class="sidebar-link">图片盗链</a></li><li><a href="/yx-docs/questions/跨域.html" class="sidebar-link">何为跨域？</a></li><li><a href="/yx-docs/questions/http协议.html" class="sidebar-link">HTTP协议</a></li><li><a href="/yx-docs/questions/https介绍.html" class="sidebar-link">HTTPS介绍</a></li><li><a href="/yx-docs/questions/JS异步编程.html" class="sidebar-link">异步编程</a></li><li><a href="/yx-docs/questions/Event Loop是什么.html" class="sidebar-link">EVENT LOOP</a></li><li><a href="/yx-docs/questions/输入URL回车后的过程.html" class="sidebar-link">浏览器输入 URL 回车之后发生了什么</a></li><li><a href="/yx-docs/questions/onload.html" class="sidebar-link">window.onload() &amp; document.ready() 事件先后顺序</a></li><li><a href="/yx-docs/questions/会话技术.html" class="sidebar-link">会话技术(Cookie和Session)</a></li><li><a href="/yx-docs/questions/XSS CSRF 点击劫持攻击.html" class="sidebar-link">1. XSS攻击</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Vue</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/yx-docs/vue/vue技巧大全.html" class="sidebar-link">VUE技巧大全</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="js模块化编程之彻底弄懂commonjs和amd-cmd"><a href="#js模块化编程之彻底弄懂commonjs和amd-cmd" class="header-anchor">#</a> js模块化编程之彻底弄懂CommonJS和AMD/CMD！</h1> <p>先回答我：为什么模块很重要？</p> <p>答：因为有了模块，我们就可以更方便地使用别人的代码，想要什么功能，就加载什么模块。
但是，这样做有一个前提，那就是大家必须以同样的方式编写模块，否则你有你的写法，我有我的写法，岂不是乱了套！</p> <p>于是下面三个模块规范出来了，这篇文章也出来了（拼出来的 {捂脸笑}）。</p> <p>JS中的模块规范（CommonJS，AMD，CMD），如果你听过js模块化这个东西，那么你就应该听过或CommonJS或AMD甚至是CMD这些规范咯，我也听过，但之前也真的是听听而已。 现在就看看吧，这些规范到底是啥东西，干嘛的。本文包括这三个规范的来源及对应的产物的原理。</p> <h2 id="一、commonjs"><a href="#一、commonjs" class="header-anchor">#</a> 一、CommonJS</h2> <p>一开始大家都认为JS是辣鸡，没什么用，官方定义的API只能构建基于浏览器的应用程序，逗我呢，这太狭隘了吧(用了个高端词，嘎嘎)，CommonJS就按耐不住了，CommonJS API定义很多普通应用程序（主要指非浏览器的应用）使用的API，从而填补了这个空白。它的终极目标是提供一个类似Python，Ruby和Java标准库。这样的话，开发者可以使用CommonJS API编写应用程序，然后这些应用可以运行在不同的JavaScript解释器和不同的主机环境中。</p> <p>在兼容CommonJS的系统中，你可以使用JavaScript开发以下程序：</p> <p>(1).服务器端JavaScript应用程序
(2).命令行工具
(3).图形界面应用程序
(4).混合应用程序（如，Titanium或Adobe AIR）</p> <p>2009年，美国程序员Ryan Dahl创造了node.js项目，将javascript语言用于服务器端编程。这标志&quot;Javascript模块化编程&quot;正式诞生。因为老实说，在浏览器环境下，没有模块也不是特别大的问题，毕竟网页程序的复杂性有限；但是在服务器端，一定要有模块，与操作系统和其他应用程序互动，否则根本没法编程。NodeJS是CommonJS规范的实现，webpack 也是以CommonJS的形式来书写。</p> <p>node.js的模块系统，就是参照CommonJS规范实现的。在CommonJS中，有一个全局性方法require()，用于加载模块。假定有一个数学模块math.js，就可以像下面这样加载。</p> <p>var math = require('math');</p> <p>然后，就可以调用模块提供的方法：</p> <p>var math = require('math');</p> <div class="language- extra-class"><pre><code>  math.add(2,3); // 5
</code></pre></div><p>CommonJS定义的模块分为:{模块引用(require)} {模块定义(exports)} {模块标识(module)}</p> <p>require()用来引入外部模块；exports对象用于导出当前模块的方法或变量，唯一的导出口；module对象就代表模块本身。</p> <p>虽说Node遵循CommonJS的规范，但是相比也是做了一些取舍，填了一些新东西的。</p> <p>不过，说了CommonJS也说了Node，那么我觉得也得先了解下NPM了。NPM作为Node的包管理器，不是为了帮助Node解决依赖包的安装问题嘛，那它肯定也要遵循CommonJS规范啦，它遵循包规范（还是理论）的。CommonJS WIKI讲了它的历史，还介绍了modules和packages等。</p> <p>下面讲讲commonJS的原理以及简易实现：</p> <p>1、原理
浏览器不兼容CommonJS的根本原因，在于缺少四个Node.js环境的变量。</p> <p>module
exports
require
global</p> <p>只要能够提供这四个变量，浏览器就能加载 CommonJS 模块。</p> <p>下面是一个简单的示例。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> module <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">exports</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  exports<span class="token punctuation">.</span><span class="token function-variable function">multiply</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> n <span class="token operator">*</span> <span class="token number">1000</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">var</span> f <span class="token operator">=</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span>multiply<span class="token punctuation">;</span>
<span class="token function">f</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token comment">// 5000 </span>
</code></pre></div><p>上面代码向一个立即执行函数提供 module 和 exports 两个外部变量，模块就放在这个立即执行函数里面。模块的输出值放在 module.exports 之中，这样就实现了模块的加载。</p> <p>2、Browserify 的实现
知道了原理，就能做出工具了。Browserify 是目前最常用的 CommonJS 格式转换的工具。</p> <p>请看一个例子，main.js 模块加载 foo.js 模块。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// foo.js</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// main.js</span>
<span class="token keyword">var</span> foo <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./foo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">foo</span><span class="token punctuation">(</span><span class="token string">&quot;Hi&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>使用下面的命令，就能将main.js转为浏览器可用的格式。</p> <p>$ browserify main.js &gt; compiled.js</p> <p>Browserify到底做了什么？安装一下browser-unpack，就能看清楚了。</p> <blockquote><p>$ npm install browser-unpack -g</p></blockquote> <p>然后，将前面生成的compile.js解包。</p> <p>$ browser-unpack &lt; compiled.js</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    <span class="token property">&quot;id&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token property">&quot;source&quot;</span><span class="token operator">:</span><span class="token string">&quot;module.exports = function(x) {\n  console.log(x);\n};&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;deps&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">&quot;id&quot;</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token property">&quot;source&quot;</span><span class="token operator">:</span><span class="token string">&quot;var foo = require(\&quot;./foo\&quot;);\nfoo(\&quot;Hi\&quot;);&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;deps&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;./foo&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;entry&quot;</span><span class="token operator">:</span><span class="token boolean">true</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre></div><p>可以看到，browerify 将所有模块放入一个数组，id 属性是模块的编号，source 属性是模块的源码，deps 属性是模块的依赖。</p> <p>因为 main.js 里面加载了 foo.js，所以 deps 属性就指定 ./foo 对应1号模块。执行的时候，浏览器遇到 require('./foo') 语句，就自动执行1号模块的 source 属性，并将执行后的 module.exports 属性值输出。</p> <p>3、Tiny Browser Require
虽然 Browserify 很强大，但不能在浏览器里操作，有时就很不方便。</p> <p>我根据 mocha 的内部实现，做了一个纯浏览器的 CommonJS 模块加载器 tiny-browser-require 。完全不需要命令行，直接放进浏览器即可，所有代码只有30多行。</p> <p>它的逻辑非常简单，就是把模块读入数组，加载路径就是模块的id。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token parameter">p</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">var</span> path <span class="token operator">=</span> require<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> mod <span class="token operator">=</span> require<span class="token punctuation">.</span>modules<span class="token punctuation">[</span>path<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mod<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'failed to require &quot;'</span> <span class="token operator">+</span> p <span class="token operator">+</span> <span class="token string">'&quot;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mod<span class="token punctuation">.</span>exports<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mod<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">mod</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>mod<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> mod<span class="token punctuation">,</span> mod<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> require<span class="token punctuation">.</span><span class="token function">relative</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> mod<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

require<span class="token punctuation">.</span>modules <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

require<span class="token punctuation">.</span><span class="token function-variable function">resolve</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">var</span> orig <span class="token operator">=</span> path<span class="token punctuation">;</span>
  <span class="token keyword">var</span> reg <span class="token operator">=</span> path <span class="token operator">+</span> <span class="token string">'.js'</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> index <span class="token operator">=</span> path <span class="token operator">+</span> <span class="token string">'/index.js'</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> require<span class="token punctuation">.</span>modules<span class="token punctuation">[</span>reg<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> reg
    <span class="token operator">||</span> require<span class="token punctuation">.</span>modules<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> index
    <span class="token operator">||</span> orig<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

require<span class="token punctuation">.</span><span class="token function-variable function">register</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  require<span class="token punctuation">.</span>modules<span class="token punctuation">[</span>path<span class="token punctuation">]</span> <span class="token operator">=</span> fn<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

require<span class="token punctuation">.</span><span class="token function-variable function">relative</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">parent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">p</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'.'</span> <span class="token operator">!=</span> p<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">require</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> path <span class="token operator">=</span> parent<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> segs <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    path<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> segs<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> seg <span class="token operator">=</span> segs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'..'</span> <span class="token operator">==</span> seg<span class="token punctuation">)</span> path<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'.'</span> <span class="token operator">!=</span> seg<span class="token punctuation">)</span> path<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>seg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token function">require</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>使用的时候，先将上面的代码放入页面。然后，将模块放在如下的立即执行函数里面，就可以调用了。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">&quot;require.js&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
require<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">&quot;moduleId&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> require</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">// Module code goes here</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;moduleId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre></div><p>还是以前面的 main.js 加载 foo.js 为例。</p> <div class="language-js extra-class"><pre class="language-js"><code>require<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">&quot;./foo.js&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> require</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> foo <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./foo.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">foo</span><span class="token punctuation">(</span><span class="token string">&quot;Hi&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>注意，这个库只模拟了 require 、module 、exports 三个变量，如果模块还用到了 global 或者其他 Node 专有变量（比如 process），就通过立即执行函数提供即可。</p> <h2 id="二、amd"><a href="#二、amd" class="header-anchor">#</a> 二、AMD</h2> <p>基于commonJS规范的nodeJS出来以后，服务端的模块概念已经形成，很自然地，大家就想要客户端模块。而且最好两者能够兼容，一个模块不用修改，在服务器和浏览器都可以运行。但是，由于一个重大的局限，使得CommonJS规范不适用于浏览器环境。还是上面的代码，如果在浏览器中运行，会有一个很大的问题，你能看出来吗？</p> <p>var math = require('math');</p> <p>math.add(2, 3);</p> <p>第二行math.add(2, 3)，在第一行require('math')之后运行，因此必须等math.js加载完成。也就是说，如果加载时间很长，整个应用就会停在那里等。您会注意到 require 是同步的。</p> <p>这对服务器端不是一个问题，因为所有的模块都存放在本地硬盘，可以同步加载完成，等待时间就是硬盘的读取时间。但是，对于浏览器，这却是一个大问题，因为模块都放在服务器端，等待时间取决于网速的快慢，可能要等很长时间，浏览器处于&quot;假死&quot;状态。</p> <p>因此，浏览器端的模块，不能采用&quot;同步加载&quot;（synchronous），只能采用&quot;异步加载&quot;（asynchronous）。这就是AMD规范诞生的背景。</p> <p>CommonJS是主要为了JS在后端的表现制定的，他是不适合前端的，AMD(异步模块定义)出现了，它就主要为前端JS的表现制定规范。</p> <p>AMD是&quot;Asynchronous Module Definition&quot;的缩写，意思就是&quot;异步模块定义&quot;。它采用异步方式加载模块，模块的加载不影响它后面语句的运行。所有依赖这个模块的语句，都定义在一个回调函数中，等到加载完成之后，这个回调函数才会运行。</p> <p>AMD也采用require()语句加载模块，但是不同于CommonJS，它要求两个参数：</p> <p>require([module], callback);</p> <p>第一个参数[module]，是一个数组，里面的成员就是要加载的模块；第二个参数callback，则是加载成功之后的回调函数。如果将前面的代码改写成AMD形式，就是下面这样：</p> <p>require(['math'], function (math) {</p> <p>math.add(2, 3);</p> <p>});</p> <p>math.add()与math模块加载不是同步的，浏览器不会发生假死。所以很显然，AMD比较适合浏览器环境。目前，主要有两个Javascript库实现了AMD规范：require.js和curl.js。</p> <p>RequireJS就是实现了AMD规范的呢。</p> <p>详细概括：下面以RequireJS为例说明AMD规范</p> <p>一、为什么要用require.js？</p> <p>最早的时候，所有Javascript代码都写在一个文件里面，只要加载这一个文件就够了。后来，代码越来越多，一个文件不够了，必须分成多个文件，依次加载。下面的网页代码，相信很多人都见过。</p> <p><script src="1.js"></script> <script src="2.js"></script> <script src="3.js"></script> <script src="4.js"></script> <script src="5.js"></script> <script src="6.js"></script></p> <p>这段代码依次加载多个js文件。</p> <p>这样的写法有很大的缺点。首先，加载的时候，浏览器会停止网页渲染，加载文件越多，网页失去响应的时间就会越长；其次，由于js文件之间存在依赖关系，因此必须严格保证加载顺序（比如上例的1.js要在2.js的前面），依赖性最大的模块一定要放到最后加载，当依赖关系很复杂的时候，代码的编写和维护都会变得困难。</p> <p>require.js的诞生，就是为了解决这两个问题：</p> <p></p> <p>（1）实现js文件的异步加载，避免网页失去响应；</p> <p>（2）管理模块之间的依赖性，便于代码的编写和维护。</p> <p>二、require.js的加载</p> <p>使用require.js的第一步，是先去官方网站下载最新版本。</p> <p>下载后，假定把它放在js子目录下面，就可以加载了。</p> <p><script src="js/require.js"></script></p> <p>有人可能会想到，加载这个文件，也可能造成网页失去响应。解决办法有两个，一个是把它放在网页底部加载，另一个是写成下面这样：</p> <p><script src="js/require.js" defer="defer" async="async"></script></p> <p>async属性表明这个文件需要异步加载，避免网页失去响应。IE不支持这个属性，只支持defer，所以把defer也写上。</p> <p>加载require.js以后，下一步就要加载我们自己的代码了。假定我们自己的代码文件是main.js，也放在js目录下面。那么，只需要写成下面这样就行了：</p> <p><script src="js/require.js" data-main="js/main"></script></p> <p>data-main属性的作用是，指定网页程序的主模块。在上例中，就是js目录下面的main.js，这个文件会第一个被require.js加载。由于require.js默认的文件后缀名是js，所以可以把main.js简写成main。</p> <p>三、主模块的写法</p> <p>上一节的main.js，我把它称为&quot;主模块&quot;，意思是整个网页的入口代码。它有点像C语言的main()函数，所有代码都从这儿开始运行。</p> <p>下面就来看，怎么写main.js。</p> <p>如果我们的代码不依赖任何其他模块，那么可以直接写入javascript代码。</p> <p>// main.js</p> <p>alert(&quot;加载成功！&quot;);</p> <p>但这样的话，就没必要使用require.js了。真正常见的情况是，主模块依赖于其他模块，这时就要使用AMD规范定义的的require()函数。</p> <p>// main.js</p> <p>require(['moduleA', 'moduleB', 'moduleC'], function (moduleA, moduleB, moduleC){</p> <p>// some code here</p> <p>});</p> <p>require()函数接受两个参数。第一个参数是一个数组，表示所依赖的模块，上例就是['moduleA', 'moduleB', 'moduleC']，即主模块依赖这三个模块；第二个参数是一个回调函数，当前面指定的模块都加载成功后，它将被调用。加载的模块会以参数形式传入该函数，从而在回调函数内部就可以使用这些模块。</p> <p>require()异步加载moduleA，moduleB和moduleC，浏览器不会失去响应；它指定的回调函数，只有前面的模块都加载成功后，才会运行，解决了依赖性的问题。</p> <p>下面，我们看一个实际的例子。</p> <p>假定主模块依赖jquery、underscore和backbone这三个模块，main.js就可以这样写：</p> <p>require(['jquery', 'underscore', 'backbone'], function ($, _, Backbone){</p> <p>// some code here</p> <p>});</p> <p>require.js会先加载jQuery、underscore和backbone，然后再运行回调函数。主模块的代码就写在回调函数中。</p> <p>四、模块的加载</p> <p>上一节最后的示例中，主模块的依赖模块是['jquery', 'underscore', 'backbone']。默认情况下，require.js假定这三个模块与main.js在同一个目录，文件名分别为jquery.js，underscore.js和backbone.js，然后自动加载。</p> <p>使用require.config()方法，我们可以对模块的加载行为进行自定义。require.config()就写在主模块（main.js）的头部。参数就是一个对象，这个对象的paths属性指定各个模块的加载路径。</p> <p>require.config({</p> <p>paths: {</p> <p>&quot;jquery&quot;: &quot;jquery.min&quot;,
　　　　　　&quot;underscore&quot;: &quot;underscore.min&quot;,
　　　　　　&quot;backbone&quot;: &quot;backbone.min&quot;</p> <p>}</p> <p>});</p> <p>上面的代码给出了三个模块的文件名，路径默认与main.js在同一个目录（js子目录）。如果这些模块在其他目录，比如js/lib目录，则有两种写法。一种是逐一指定路径。</p> <p>require.config({</p> <p>paths: {</p> <p>&quot;jquery&quot;: &quot;lib/jquery.min&quot;,
　　　　　　&quot;underscore&quot;: &quot;lib/underscore.min&quot;,
　　　　　　&quot;backbone&quot;: &quot;lib/backbone.min&quot;</p> <p>}</p> <p>});</p> <p>另一种则是直接改变基目录（baseUrl）。</p> <p>require.config({</p> <p>baseUrl: &quot;js/lib&quot;,</p> <p>paths: {</p> <p>&quot;jquery&quot;: &quot;jquery.min&quot;,
　　　　　　&quot;underscore&quot;: &quot;underscore.min&quot;,
　　　　　　&quot;backbone&quot;: &quot;backbone.min&quot;</p> <p>}</p> <p>});</p> <p>如果某个模块在另一台主机上，也可以直接指定它的网址，比如：</p> <p>require.config({</p> <p>paths: {</p> <p>&quot;jquery&quot;: &quot;https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min&quot;</p> <p>}</p> <p>});</p> <p>require.js要求，每个模块是一个单独的js文件。这样的话，如果加载多个模块，就会发出多次HTTP请求，会影响网页的加载速度。因此，require.js提供了一个优化工具，当模块部署完毕以后，可以用这个工具将多个模块合并在一个文件中，减少HTTP请求数。</p> <p>五、AMD模块的写法</p> <p>require.js加载的模块，采用AMD规范。也就是说，模块必须按照AMD的规定来写。</p> <p>具体来说，就是模块必须采用特定的define()函数来定义。如果一个模块不依赖其他模块，那么可以直接定义在define()函数之中。</p> <p>假定现在有一个math.js文件，它定义了一个math模块。那么，math.js就要这样写：</p> <p>// math.js</p> <p>define(function (){</p> <p>var add = function (x,y){</p> <p>return x+y;</p> <p>};</p> <p>return {</p> <p>add: add
　　　　};</p> <p>});</p> <p>加载方法如下：</p> <p>// main.js</p> <p>require(['math'], function (math){</p> <p>alert(math.add(1,1));</p> <p>});</p> <p>如果这个模块还依赖其他模块，那么define()函数的第一个参数，必须是一个数组，指明该模块的依赖性。</p> <p>define(['myLib'], function(myLib){</p> <p>function foo(){</p> <p>myLib.doSomething();</p> <p>}</p> <p>return {</p> <p>foo : foo</p> <p>};</p> <p>});</p> <p>当require()函数加载上面这个模块的时候，就会先加载myLib.js文件。</p> <p>六、加载非规范的模块</p> <p>理论上，require.js加载的模块，必须是按照AMD规范、用define()函数定义的模块。但是实际上，虽然已经有一部分流行的函数库（比如jQuery）符合AMD规范，更多的库并不符合。那么，require.js是否能够加载非规范的模块呢？</p> <p>回答是可以的。</p> <p>这样的模块在用require()加载之前，要先用require.config()方法，定义它们的一些特征。</p> <p>举例来说，underscore和backbone这两个库，都没有采用AMD规范编写。如果要加载它们的话，必须先定义它们的特征。</p> <p>require.config({</p> <p>shim: {</p> <p>'underscore':{
　　　　　　　　exports: '_'
　　　　　　},</p> <p>'backbone': {
　　　　　　　　deps: ['underscore', 'jquery'],
　　　　　　　　exports: 'Backbone'
　　　　　　}</p> <p>}</p> <p>});</p> <p>require.config()接受一个配置对象，这个对象除了有前面说过的paths属性之外，还有一个shim属性，专门用来配置不兼容的模块。具体来说，每个模块要定义（1）exports值（输出的变量名），表明这个模块外部调用时的名称；（2）deps数组，表明该模块的依赖性。</p> <p>比如，jQuery的插件可以这样定义：</p> <p>shim: {</p> <p>'jquery.scroll': {</p> <p>deps: ['jquery'],</p> <p>exports: 'jQuery.fn.scroll'</p> <p>}</p> <p>}</p> <p>七、require.js插件</p> <p>require.js还提供一系列插件，实现一些特定的功能。</p> <p>domready插件，可以让回调函数在页面DOM结构加载完成后再运行。</p> <p>require(['domready!'], function (doc){</p> <p>// called once the DOM is ready</p> <p>});</p> <p>text和image插件，则是允许require.js加载文本和图片文件。</p> <p>define([</p> <p>'text!review.txt',</p> <p>'image!cat.jpg'</p> <p>],</p> <p>function(review,cat){</p> <p>console.log(review);</p> <p>document.body.appendChild(cat);</p> <p>}</p> <p>);</p> <p>类似的插件还有json和mdown，用于加载json文件和markdown文件。（完）</p> <p>另一个人的概括(有点简单)：</p> <p>AMD就只有一个接口：define(id?,dependencies?,factory);</p> <p>它要在声明模块的时候制定所有的依赖(dep)，并且还要当做形参传到factory中，像这样：</p> <p>1 define(['dep1','dep2'],function(dep1,dep2){...});</p> <p>要是没什么依赖，就定义简单的模块，下面这样就可以啦：</p> <p>复制代码
复制代码
1 define(function(){
2     var exports = {};
3     exports.method = function(){...};
4     return exports;
5 });
复制代码
复制代码</p> <p>咦，这里有define，把东西包装起来啦，那Node实现中怎么没看到有define关键字呢，它也要把东西包装起来呀，其实吧，只是Node隐式包装了而已.....</p> <p>这有AMD的WIKI中文版，讲了很多蛮详细的东西，用到的时候可以查看：AMD的WIKI中文版</p> <p>三、CMD</p> <p>大名远扬的玉伯写了seajs，就是遵循他提出的CMD规范，与AMD蛮相近的，不过用起来感觉更加方便些，最重要的是中文版，应有尽有：seajs官方doc</p> <p>1 define(function(require,exports,module){...});
用过seajs吧，这个不陌生吧，对吧。</p> <p>前面说AMD，说RequireJS实现了AMD，CMD看起来与AMD好像呀，那RequireJS与SeaJS像不像呢？</p> <p>虽然CMD与AMD蛮像的，但区别还是挺明显的，官方非官方都有阐述和理解，我觉得吧，说的都挺好：</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/yx-docs/assets/js/app.5a460998.js" defer></script><script src="/yx-docs/assets/js/2.beed6d36.js" defer></script><script src="/yx-docs/assets/js/29.c181a55e.js" defer></script>
  </body>
</html>
